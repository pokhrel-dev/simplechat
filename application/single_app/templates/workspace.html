<!-- templates/workspace.html -->
{% extends "base.html" %}
{% block title %} Personal Workspace - {{ app_settings.app_title }} {% endblock %}
{% block head %}
  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplemde/dist/simplemde.min.css" />
   LOCAL VERSION BELOW -->
   <link rel="stylesheet" href="/static/css/simplemde.min.css" />

  <style>
    /* Force fixed layout so columns don't expand when content changes */
    #documents-table, #prompts-table, #agents-table { /* Apply to all tables */
      table-layout: fixed;
      width: 100%;
    }

    /* Uniform width for action buttons (Approve, Delete, Chat) */
    .action-btn-wide {
      min-width: 90px;
    }

    /* --- Documents Table Styles --- */
    /* Example: Keep the expand-arrow column narrow */
    #documents-table th:nth-child(1),
    #documents-table td:nth-child(1) {
      width: 50px;
      text-align: Left;
    }
    
    /* Styles for document checkboxes */
    .document-checkbox {
      cursor: pointer;
      min-width: 18px;
      min-height: 18px;
      display: none; /* Hide checkboxes by default */
    }
    
    /* Show checkboxes when in selection mode */
    .selection-mode .document-checkbox {
      display: block;
    }
    
    /* Ensure the delete button is properly styled */
    #delete-selected-btn, #remove-selected-btn {
      transition: all 0.3s ease;
    }
    
    /* Add some padding to the left when in selection mode */
    .selection-mode .document-row {
      padding-left: 0.5rem;
    }
    
    /* Dropdown menu for actions */
    .action-dropdown .dropdown-toggle::after {
      display: none;
    }
    /* File Name column */
    #documents-table th:nth-child(2),
    #documents-table td:nth-child(2) {
      min-width: 50px;
      max-width: 150px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    /* Title column */
    #documents-table th:nth-child(3),
    #documents-table td:nth-child(3) {
      min-width: 50px;
      max-width: 200px;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    /* Actions column (now 4th column) */
    #documents-table th:nth-child(4),
    #documents-table td:nth-child(4) {
      width: 240px; /* Increased to fit Share button with badge */
    }

    /* --- Prompts Table Styles --- */
    #prompts-table th:nth-child(1), /* Prompt Name */
    #prompts-table td:nth-child(1) {
        width: 70%; /* Give name more space */
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
    }
    #prompts-table th:nth-child(2), /* Actions */
    #prompts-table td:nth-child(2) {
        width: 150px; /* Adjust as needed for buttons */
    }

    /* --- Agents Table Styles --- */
    #agents-table th:nth-child(1), /* Display Name */
    #agents-table td:nth-child(1) {
        width: 25%; /* Agent name column */
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        min-width: 120px;
    }
    #agents-table th:nth-child(2), /* Description */
    #agents-table td:nth-child(2) {
        width: 55%; /* Description column - largest */
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        min-width: 200px;
    }
    #agents-table th:nth-child(3), /* Actions */
    #agents-table td:nth-child(3) {
        width: 20%; /* Actions column */
        min-width: 120px;
    }

    /* Style for the classification badge */
    .classification-badge {
        display: inline-block;
        padding: 0.3em 0.6em;
        font-size: 0.85em;
        font-weight: 600;
        line-height: 1;
        color: #fff; /* Default white text */
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.375rem; /* Bootstrap's default badge radius */
    }
    .classification-badge.text-dark {
        color: #212529 !important; /* Bootstrap dark text color */
    }

    /* Align table cells vertically */
    #documents-table td, #prompts-table td, #agents-table td {
        vertical-align: middle;
    }

     /* Style for loading state in tables */
    .table-loading-row td {
        text-align: center;
        padding: 1.5rem;
        color: #6c757d; /* text-muted */
    }

     /* Ensure filter inputs don't overlap buttons on small screens */
    .filter-controls-row > div {
        margin-bottom: 0.5rem; /* Add some spacing below each filter group */
    }
    @media (min-width: 768px) { /* md breakpoint */
       .filter-controls-row > div {
           margin-bottom: 0;
       }
       .filter-buttons-col {
          text-align: end;
       }
    }
    /* Add spacing between filter rows */
    .filter-controls-row + .filter-controls-row {
        margin-top: 0.75rem; /* Add space above the second filter row */
    }

  </style>
{% endblock %}

{% block content %}
  <div class="container">
    <h2>Personal Workspace</h2>

    <!-- Migration Banner (Hidden by default) -->
    <div id="migration-banner" class="alert alert-info alert-dismissible fade show" role="alert" style="display: none;">
      <div class="d-flex align-items-center">
        <i class="bi bi-arrow-up-circle me-2"></i>
        <div class="flex-grow-1">
          <strong>Data Migration Available</strong><br>
          <small>We've found legacy agents and/or actions in your old settings. Click to migrate them to the new improved storage system for better performance and reliability.</small>
        </div>
        <div class="ms-3">
          <button id="migrate-all-btn" class="btn btn-primary btn-sm me-2">
            <i class="bi bi-arrow-up"></i> Migrate Now
          </button>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      </div>
      <div id="migration-progress" class="mt-2" style="display: none;">
        <div class="progress" style="height: 4px;">
          <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
        </div>
        <small class="text-muted mt-1" id="migration-status-text">Preparing migration...</small>
      </div>
    </div>

    <!-- Nav Tabs - Hide when left nav is enabled -->
    <ul class="nav nav-tabs{% if nav_layout == 'left' %} d-none{% endif %}" id="workspaceTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link active"
          id="documents-tab-btn"
          data-bs-toggle="tab"
          data-bs-target="#documents-tab"
          type="button"
          role="tab"
          aria-controls="documents-tab"
          aria-selected="true"
        >
          Your Documents
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="prompts-tab-btn"
          data-bs-toggle="tab"
          data-bs-target="#prompts-tab"
          type="button"
          role="tab"
          aria-controls="prompts-tab"
          aria-selected="false"
        >
          Your Prompts
        </button>
      </li>
      {% if settings.per_user_semantic_kernel and settings.enable_semantic_kernel %}
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="agents-tab-btn"
          data-bs-toggle="tab"
          data-bs-target="#agents-tab"
          type="button"
          role="tab"
          aria-controls="agents-tab"
          aria-selected="false"
        >
          Your Agents
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          id="plugins-tab-btn"
          data-bs-toggle="tab"
          data-bs-target="#plugins-tab"
          type="button"
          role="tab"
          aria-controls="plugins-tab"
          aria-selected="false"
        >
          Your Actions
        </button>
      </li>
      {% endif %}
    </ul>

    <!-- Tab Panes -->
    <div class="tab-content" id="workspaceTabContent">
      <!-- ============= DOCUMENTS TAB ============= -->
      <div
        class="tab-pane fade show active"
        id="documents-tab"
        role="tabpanel"
        aria-labelledby="documents-tab-btn"
      >
        <div class="card p-3 my-3">
          <div id="legacy-update-prompt-placeholder"></div> 
          <h5>Your Documents</h5>
          <p class="text-muted small">Only you can see documents you upload.</p>

          <!-- Document Upload Form -->
          <div class="mb-3">
            <div id="upload-area" class="upload-area text-center p-4 border border-2 border-dashed rounded bg-light" style="cursor:pointer; transition: border-color 0.2s;">
              <input type="file" id="workspace-file-input" multiple style="display:none;" />
              <div class="upload-area-content">
                <i class="bi bi-cloud-arrow-up display-4 text-primary mb-2"></i>
                <div class="fw-bold">Drag & drop files here or <span class="text-primary text-decoration-underline">click to browse</span></div>
                <div class="small text-muted mt-1">Allowed: txt, pdf, docx, xlsx, xls, csv, pptx, html, jpg, jpeg, png, bmp, tiff, tif, heif, md, json{% if enable_video_file_support in [True, 'True', 'true'] %}, mp4, mov, avi, wmv, mkv, webm{% endif %}{% if enable_audio_file_support in [True, 'True', 'true'] %}, mp3, wav, ogg, aac, flac, m4a{% endif %}</div>
              </div>
            </div>
            <span id="upload-status" class="ms-2 text-muted small" style="display:none;"></span>
            <!-- Per-file upload progress bars -->
            <div id="workspace-upload-progress-container" class="mt-2" style="display:none;"></div>
          </div>

          <!-- Document Filters -->
          <button class="btn btn-outline-secondary btn-sm mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#docs-filters-collapse" aria-expanded="false" aria-controls="docs-filters-collapse" id="docs-filters-toggle-btn">
            Show Search/Filters
          </button>
          <div class="collapse" id="docs-filters-collapse">
            <!-- Filter Row 1: Main Search & Classification -->
            <div class="row mb-3 align-items-end filter-controls-row">
                {% if enable_document_classification in [True, 'True', 'true'] %}
                    <div class="col-md-4">
                        <label for="docs-search-input" class="form-label mb-1 small">Search File Name/Title:</label>
                        <input type="search" id="docs-search-input" class="form-control form-control-sm" placeholder="Enter search term...">
                    </div>
                    <div class="col-md-3">
                        <label for="docs-classification-filter" class="form-label mb-1 small">Filter by Classification:</label>
                        <select id="docs-classification-filter" class="form-select form-select-sm">
                             <option value="">(All Classifications)</option>
                             <option value="none">(No Classification)</option>
                             {% for cat in settings.document_classification_categories %}
                                <option value="{{ cat.label }}">{{ cat.label }}</option>
                             {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" id="docs-shared-only-filter">
                            <label class="form-check-label small" for="docs-shared-only-filter">
                                Show only shared files
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3 filter-buttons-col mt-2 mt-md-0">
                        <button id="docs-apply-filters-btn" class="btn btn-primary btn-sm">Apply Filters</button>
                        <button id="docs-clear-filters-btn" class="btn btn-secondary btn-sm ms-1">Clear Filters</button>
                    </div>
                {% else %}
                    <!-- Layout when classification is disabled -->
                    <div class="col-md-6">
                        <label for="docs-search-input" class="form-label mb-1 small">Search File Name/Title:</label>
                        <input type="search" id="docs-search-input" class="form-control form-control-sm" placeholder="Enter search term...">
                    </div>
                    <div class="col-md-3">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" id="docs-shared-only-filter">
                            <label class="form-check-label small" for="docs-shared-only-filter">
                                Show only shared files
                            </label>
                        </div>
                    </div>
                    <div class="col-md-3 filter-buttons-col mt-2 mt-md-0">
                        <button id="docs-apply-filters-btn" class="btn btn-primary btn-sm">Apply Filters</button>
                        <button id="docs-clear-filters-btn" class="btn btn-secondary btn-sm ms-1">Clear Filters</button>
                    </div>
                {% endif %}
            </div>
            <!-- Filter Row 2: Metadata Filters (Always Shown, No Buttons) -->
            <div class="row mb-3 align-items-end filter-controls-row">
                <div class="col-md-3">
                    <label for="docs-author-filter" class="form-label mb-1 small">Search Authors:</label>
                    <input type="search" id="docs-author-filter" class="form-control form-control-sm" placeholder="Author name...">
                </div>
                <div class="col-md-3">
                    <label for="docs-keywords-filter" class="form-label mb-1 small">Search Keywords:</label>
                    <input type="search" id="docs-keywords-filter" class="form-control form-control-sm" placeholder="Keyword...">
                </div>
                <div class="col-md-3">
                    <label for="docs-abstract-filter" class="form-label mb-1 small">Search Abstract:</label>
                    <input type="search" id="docs-abstract-filter" class="form-control form-control-sm" placeholder="Abstract content...">
                </div>
                <div class="col-md-3 filter-buttons-col mt-2 mt-md-0">
                    <!-- Buttons removed from metadata row -->
                </div>
            </div>
          </div>
          <!-- End Metadata Filters -->

          <!-- Documents List -->
          <table class="table table-striped" id="documents-table">
            <thead>
              <tr>
                <th>
                  <!-- Expand/Collapse Column -->
                </th>
                <th>File Name</th>
                <th>Title</th>
                <th>Actions
                  <span id="bulk-actions" style="display: none; margin-left: 20px;">
                    <!-- Bulk action buttons will appear here when documents are selected -->
                    <button id="delete-selected-btn" class="btn btn-danger btn-sm me-2" style="display: none;" title="Delete selected documents">
                      <i class="bi bi-trash"></i> Delete
                    </button>
                    <button id="remove-selected-btn" class="btn btn-warning btn-sm" style="display: none;" title="Remove selected documents">
                      <i class="bi bi-x-circle"></i> Remove
                    </button>
                  </span>
                </th>
              </tr>
            </thead>
            <tbody>
              <!-- Populated by JavaScript -->
              <tr class="table-loading-row">
                <td colspan="5">
                    <div class="spinner-border spinner-border-sm me-2" role="status"><span class="visually-hidden">Loading...</span></div>
                    Loading documents...
                </td>
              </tr>
            </tbody>
          </table>

          <!-- Documents Pagination & Page Size -->
          <div class="d-flex align-items-center gap-3 mb-3 mt-3">
            <!-- Page Size Section -->
            <div>
              <label for="docs-page-size-select" class="visually-hidden">Items per page:</label>
              <select id="docs-page-size-select" class="form-select form-select-sm d-inline-block" style="width:auto;">
                <option value="10" selected>10</option>
                <option value="20">20</option>
                <option value="50">50</option>
              </select>
              <span class="ms-1 small text-muted">items per page</span>
            </div>

            <!-- Pagination Controls -->
            <div id="docs-pagination-container" class="d-flex gap-1 ms-auto">
                 <!-- Populated by JavaScript -->
            </div>
          </div>

        </div> <!-- End Card -->
      </div>
      <!-- End DOCUMENTS TAB -->

            <!-- ============= PROMPTS TAB ============= -->
      <div
        class="tab-pane fade"
        id="prompts-tab"
        role="tabpanel"
        aria-labelledby="prompts-tab-btn"
      >
        <div class="card p-3 my-3">
          <h5>Your Prompts</h5>
          <p class="text-muted">Create and manage personal prompts here.</p>
          <div class="mb-3">
            <button id="create-prompt-btn" class="btn btn-success">
              New Prompt
            </button>
          </div>

          <!-- Prompts Filters -->
          <button class="btn btn-outline-secondary btn-sm mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#prompts-filters-collapse" aria-expanded="false" aria-controls="prompts-filters-collapse" id="prompts-filters-toggle-btn">
            Show Search/Filters
          </button>
          <div class="collapse" id="prompts-filters-collapse">
            <div class="row mb-3 align-items-end filter-controls-row">
                <div class="col-md-6">
                    <label for="prompts-search-input" class="form-label mb-1 small">Search Prompt Name:</label>
                    <input type="search" id="prompts-search-input" class="form-control form-control-sm" placeholder="Enter search term...">
                </div>
                <div class="col-md-6 filter-buttons-col mt-2 mt-md-0">
                    <button id="prompts-apply-filters-btn" class="btn btn-primary btn-sm">Apply Filters</button>
                    <button id="prompts-clear-filters-btn" class="btn btn-secondary btn-sm ms-1">Clear Filters</button>
                 </div>
            </div>
          </div>

          <!-- Prompts List -->
          <table class="table table-striped" id="prompts-table">
            <thead>
              <tr>
                <th>Prompt Name</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
               <tr class="table-loading-row">
                <td colspan="2">
                    <div class="spinner-border spinner-border-sm me-2" role="status"><span class="visually-hidden">Loading...</span></div>
                    Loading prompts...
                </td>
              </tr>
            </tbody>
          </table>

          <!-- Prompts Pagination & Page Size -->
           <div class="d-flex align-items-center gap-3 mb-3 mt-3">
            <div>
              <label for="prompts-page-size-select" class="visually-hidden">Items per page:</label>
              <select id="prompts-page-size-select" class="form-select form-select-sm d-inline-block" style="width:auto;">
                <option value="10" selected>10</option>
                <option value="20">20</option>
                <option value="50">50</option>
              </select>
              <span class="ms-1 small text-muted">items per page</span>
            </div>

            <div id="prompts-pagination-container" class="d-flex gap-1 ms-auto">
                 <!-- Populated by JS -->
            </div>
          </div>

        </div> <!-- End Card -->
      </div>
      <!-- End PROMPTS TAB -->
      {% if settings.per_user_semantic_kernel and settings.enable_semantic_kernel %}
      <!-- ============= AGENTS TAB ============= -->
      <div
        class="tab-pane fade"
        id="agents-tab"
        role="tabpanel"
        aria-labelledby="agents-tab-btn"
      >
        {% if settings.allow_user_agents %}
          <div class="tab-pane-inner">
            <div class="card p-3 my-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0 d-flex align-items-center gap-2">
                  Your Agents
                </h5>
                <button class="btn btn-success btn-sm" id="create-agent-btn">New Agent</button>
              </div>
              <div class="mb-3">
                <input type="search" class="form-control" id="agents-search" placeholder="Search agents by name or description...">
              </div>
              <table class="table table-striped" id="agents-table">
                <thead><tr><th>Display Name</th><th>Description</th><th>Actions</th></tr></thead>
                <tbody id="agents-table-body">
                  <tr class="table-loading-row">
                    <td colspan="3">
                      <div class="spinner-border spinner-border-sm me-2" role="status"><span class="visually-hidden">Loading...</span></div>
                      Loading agents...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="workspace-agents-error"></div>
          </div>
        {% else %}
          <div class="alert alert-warning text-center my-4">
            Custom User Agents are currently disabled. Please ask your admin to enable agents for your workspace.
          </div>
        {% endif %}
      </div>
      <!-- End AGENTS TAB -->
      {% endif %}

      {% if settings.per_user_semantic_kernel and settings.enable_semantic_kernel %}
      <!-- ============= ACTIONS TAB ============= -->
      <div
        class="tab-pane fade"
        id="plugins-tab"
        role="tabpanel"
        aria-labelledby="plugins-tab-btn"
      >
        {% if settings.allow_user_plugins %}
          <div id="workspace-plugins-root"></div>
          <!-- Actions Table Template (hidden) -->
          <template id="plugins-table-template">
            <div class="card p-3 my-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0 d-flex align-items-center gap-2">
                  Your Actions
                </h5>
                <button class="btn btn-success btn-sm" id="create-plugin-btn">New Action</button>
              </div>
              <div class="mb-3">
                <input type="search" class="form-control" id="plugins-search" placeholder="Search actions by name or description...">
              </div>
              <table class="table table-striped" id="plugins-table">
                <thead><tr><th>Display Name</th><th>Description</th><th style="width: 140px;">Actions</th></tr></thead>
                <tbody id="plugins-table-body">
                  <!-- Populated by JS -->
                </tbody>
              </table>
            </div>
          </template>
          </div>
        {% else %}
          <div class="alert alert-warning text-center my-4">
            Custom User Actions are currently disabled. Please ask your admin to enable actions for your workspace.
          </div>
        {% endif %}
      {% endif %}
    </div>
    <!-- End Tab Content -->
  </div>
  <!--</div>-->

  <!-- Modal for Creating/Editing Prompts (Keep As Is) -->
  <div
    class="modal fade"
    id="promptModal"
    tabindex="-1"
    aria-labelledby="promptModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-xl" style="max-width: 80%">
      <form id="prompt-form">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="promptModalLabel">Create Prompt</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="prompt-id" name="prompt_id" value="" />
            <div class="mb-3">
              <label for="prompt-name" class="form-label">Prompt Name</label>
              <input
                type="text"
                class="form-control"
                id="prompt-name"
                name="name"
                required
              />
            </div>
            <div class="mb-3">
              <label for="prompt-content" class="form-label"
                >Prompt Content</label
              >
              <textarea
                class="form-control"
                id="prompt-content"
                name="content"
                rows="10"
              ></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button id="prompt-save-btn" type="submit" class="btn btn-primary">
              Save Prompt
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal for Editing Document Metadata (Keep As Is) -->
  <div
    class="modal fade"
    id="docMetadataModal"
    tabindex="-1"
    aria-labelledby="docMetadataModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <form id="doc-metadata-form">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="docMetadataModalLabel">
              Edit Document Metadata
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <div class="modal-body">
            <!-- Hidden doc-id field -->
            <input type="hidden" id="doc-id" name="doc_id" value="" />

            <!-- Document Classification -->
            {% if enable_document_classification in [True, 'True', 'true'] %}
            <div class="mb-3">
              <label for="doc-classification" class="form-label"
                >Classification</label
              >
              <select class="form-select" id="doc-classification">
                <option value="">-- Select Classification --</option>
                 <!-- Add 'none' option explicitly -->
                 <option value="none">(No Classification)</option>
                {% for cat in settings.document_classification_categories %}
                  <option value="{{ cat.label }}">{{ cat.label }}</option>
                {% endfor %}
              </select>
            </div>
            {% endif %}

            <!-- Title -->
            <div class="mb-3">
              <label for="doc-title" class="form-label">Title</label>
              <input type="text" class="form-control" id="doc-title" />
            </div>

            <!-- Abstract -->
            <div class="mb-3">
              <label for="doc-abstract" class="form-label">Abstract</label>
              <textarea
                class="form-control"
                id="doc-abstract"
                rows="3"
              ></textarea>
            </div>

            <!-- Keywords -->
            <div class="mb-3">
              <label for="doc-keywords" class="form-label"
                >Keywords (comma separated)</label
              >
              <input type="text" class="form-control" id="doc-keywords" />
            </div>

            <!-- Publication Date -->
            <div class="mb-3">
              <label for="doc-publication-date" class="form-label"
                >Publication Date</label
              >
              <input
                type="text"
                class="form-control"
                id="doc-publication-date"
                placeholder="e.g. 08/2005 or YYYY-MM-DD"
              />
            </div>

            <!-- Authors -->
            <div class="mb-3">
              <label for="doc-authors" class="form-label"
                >Authors (comma separated)</label
              >
              <input type="text" class="form-control" id="doc-authors" />
            </div>
          </div>
          <!-- end modal-body -->

          <div class="modal-footer">
            <button id="doc-save-btn" type="submit" class="btn btn-primary">
              Save Metadata
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
<div>
  <!-- Modal for Creating/Editing Agent -->

  {% include "_agent_modal.html" %}

  <!-- Modal for Creating/Editing Plugin -->

  {% include "_plugin_modal.html" %}
</div>

<!-- Share Document Modal -->
<div class="modal fade" id="shareDocumentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form id="shareDocumentForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Share Document</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <!-- Current Document Info -->
          <div class="mb-3">
            <h6 id="shareDocumentTitle">Document: <span id="shareDocumentName"></span></h6>
          </div>

          <!-- Currently Shared Users Section -->
          <div class="mb-3">
            <h6>Currently Shared With:</h6>
            <div id="currentlySharedUsers" class="border rounded p-2" style="min-height: 60px; max-height: 150px; overflow-y: auto;">
              <div id="noSharedUsers" class="text-muted">This document is not shared with anyone.</div>
              <div id="sharedUsersList"></div>
            </div>
          </div>

          <hr />

          <!-- Search Section -->
          <div class="mb-3">
            <label for="userSearchTerm" class="form-label"
              >Search for user (by name or email)</label
            >
            <input
              type="text"
              class="form-control"
              id="userSearchTerm"
              placeholder="e.g. John or jsmith@contoso.com"
            />
            <button
              type="button"
              class="btn btn-secondary btn-sm mt-2"
              id="searchUsersBtn"
            >
              Search
            </button>
            <!-- Optional: a small status label -->
            <span id="searchStatus" class="text-muted ms-2"></span>
          </div>

          <!-- Search Results Table -->
          <div
            class="table-responsive mb-3"
            style="max-height: 200px; overflow: auto"
          >
            <table class="table table-sm" id="userSearchResultsTable">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Populated by renderUserSearchResults() -->
              </tbody>
            </table>
          </div>

          <hr />

          <!-- Manual User Addition (Collapsible) -->
          <div class="mb-3">
            <button class="btn btn-link p-0 text-decoration-none" type="button" data-bs-toggle="collapse" data-bs-target="#manualUserSection" aria-expanded="false" aria-controls="manualUserSection">
              <i class="bi bi-chevron-right" id="manualUserChevron"></i> Add user manually
            </button>
            <div class="collapse mt-3" id="manualUserSection">
              <div class="card card-body">
                <div class="mb-2">
                  <label for="newUserId" class="form-label"
                    >User ID (AAD Object ID)</label
                  >
                  <input type="text" class="form-control" id="newUserId" />
                </div>
                <div class="mb-2">
                  <label for="newUserDisplayName" class="form-label">Name</label>
                  <input type="text" class="form-control" id="newUserDisplayName" />
                </div>
                <div class="mb-2">
                  <label for="newUserEmail" class="form-label">Email</label>
                  <input type="email" class="form-control" id="newUserEmail" />
                </div>
                <button type="button" id="manualAddUserBtn" class="btn btn-primary btn-sm">Add User</button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary btn-sm"
            data-bs-dismiss="modal"
          >
            Close
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
<!-- Approve Shared Document Modal -->
<div class="modal fade" id="approveSharedModal" tabindex="-1" aria-labelledby="approveSharedModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="approveSharedModalLabel">Approve Shared Document</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="approveSharedModalBody">
        <!-- Populated by JS -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-danger action-btn-wide me-1" id="approveSharedModalDenyBtn">Deny</button>
        <button type="button" class="btn btn-sm btn-secondary action-btn-wide me-1" data-bs-dismiss="modal" id="approveSharedModalCancelBtn">Cancel</button>
        <button type="button" class="btn btn-sm btn-success action-btn-wide" id="approveSharedModalApproveBtn">Approve</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  {% if settings.per_user_semantic_kernel and settings.enable_semantic_kernel %}
    <script type="module" src="/static/js/agents_common.js"></script>
    <script type="module" src="/static/js/workspace/workspace_agents.js"></script>
    <script type="module" src="/static/js/workspace/workspace_plugins.js"></script>
  {% endif %}
  <!-- <script src="https://cdn.jsdelivr.net/npm/simplemde/dist/simplemde.min.js"></script>
   LOCAL VERSION BELOW -->
   <script src="/static/js/simplemde/simplemde.min.js"></script>

  <script>
    // Pass settings/flags needed by JS
    window.classification_categories = JSON.parse('{{ settings.document_classification_categories|tojson(indent=None)|safe }}' || '[]');
    if (!Array.isArray(window.classification_categories)) {
        window.classification_categories = [];
    }
    window.enable_document_classification = "{{ enable_document_classification | tojson }}";
    window.enable_extract_meta_data = "{{ enable_extract_meta_data | tojson }}";
    window.enable_video_file_support = "{{ enable_video_file_support | tojson }}";
    window.enable_audio_file_support = "{{ enable_audio_file_support | tojson }}";
    window.enable_file_sharing = "{{ enable_file_sharing | tojson }}";
    window.max_file_size_mb = {{ settings.max_file_size_mb | default(16) }};
    
    // Pass current user ID for ownership checks
    window.current_user_id = "{{ session.get('user', {}).get('oid', '') }}";

    // --- Filter toggle button logic ---
    document.addEventListener("DOMContentLoaded", function() {
      // Documents tab
      var docsToggleBtn = document.getElementById("docs-filters-toggle-btn");
      var docsCollapse = document.getElementById("docs-filters-collapse");
      if (docsToggleBtn && docsCollapse) {
        docsCollapse.addEventListener("show.bs.collapse", function() {
          docsToggleBtn.textContent = "Hide Search/Filters";
        });
        docsCollapse.addEventListener("hide.bs.collapse", function() {
          docsToggleBtn.textContent = "Show Search/Filters";
        });
      }
      
      // Initialize document selection functionality
      const documentsTable = document.getElementById("documents-table");
      if (documentsTable) {
        // Make sure selection mode is initially off
        documentsTable.classList.remove('selection-mode');
      }
      
      // Initialize event delegation for document checkboxes
      document.addEventListener('click', function(event) {
        // Handle clicks on document checkboxes
        if (event.target.classList.contains('document-checkbox')) {
          const documentId = event.target.getAttribute('data-document-id');
          if (window.updateSelectedDocuments) {
            window.updateSelectedDocuments(documentId, event.target.checked);
          }
        }
      });
      // Prompts tab
      var promptsToggleBtn = document.getElementById("prompts-filters-toggle-btn");
      var promptsCollapse = document.getElementById("prompts-filters-collapse");
      if (promptsToggleBtn && promptsCollapse) {
        promptsCollapse.addEventListener("show.bs.collapse", function() {
          promptsToggleBtn.textContent = "Hide Search/Filters";
        });
        promptsCollapse.addEventListener("hide.bs.collapse", function() {
          promptsToggleBtn.textContent = "Show Search/Filters";
        });
      }

      // Hide upload status and progress container unless needed
      var uploadStatus = document.getElementById("upload-status");
      var uploadProgress = document.getElementById("workspace-upload-progress-container");
      if (uploadStatus) uploadStatus.style.display = "none";
      if (uploadProgress) uploadProgress.style.display = "none";

      // Show them only when content is set (for status) or children exist (for progress)
      function showUploadStatusIfNeeded() {
        if (uploadStatus && uploadStatus.textContent.trim() !== "") {
          uploadStatus.style.display = "";
        } else if (uploadStatus) {
          uploadStatus.style.display = "none";
        }
        if (uploadProgress && uploadProgress.children.length > 0) {
          uploadProgress.style.display = "";
        } else if (uploadProgress) {
          uploadProgress.style.display = "none";
        }
      }

      // Patch the upload logic to call showUploadStatusIfNeeded after updates
      // (This is a fallback in case the main upload JS doesn't already do this)
      var origSetStatus = uploadStatus && Object.getOwnPropertyDescriptor(Object.getPrototypeOf(uploadStatus), 'textContent')?.set;
      if (uploadStatus && origSetStatus) {
        Object.defineProperty(uploadStatus, 'textContent', {
          set: function(value) {
            origSetStatus.call(this, value);
            showUploadStatusIfNeeded();
          },
          get: function() {
            return origSetStatus.get ? origSetStatus.get.call(this) : this.innerText;
          }
        });
      }
      // Also observe DOM changes to the progress container
      if (uploadProgress) {
        var observer = new MutationObserver(showUploadStatusIfNeeded);
        observer.observe(uploadProgress, { childList: true, subtree: false });
      }
      // Initial call
      showUploadStatusIfNeeded();
    });
  </script>

  <script type="module" src="{{ url_for('static', filename='js/workspace/workspace-utils.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='js/workspace/workspace-documents.js') }}"></script>
  <script src="{{ url_for('static', filename='js/workspace/workspace-documents-sharing.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='js/workspace/workspace-prompts.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='js/plugin_modal_stepper.js') }}"></script>
  <script src="{{ url_for('static', filename='js/workspace_sidebar_nav.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='js/workspace/workspace-migration.js') }}"></script>
  <script type="module" src="{{ url_for('static', filename='js/workspace/workspace-init.js') }}"></script>

{% endblock %}
