<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Table Support Test - SimpleChat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .message-text table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .message-text thead {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }
        .message-text th, .message-text td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            vertical-align: top;
        }
        .message-text th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.875rem;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        .message-text tbody tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .message-text tbody tr:hover {
            background-color: #e9ecef;
            transition: background-color 0.2s ease;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .failure { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        pre {
            background: #fff;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 300px;
        }
        .stats {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>ğŸ§ª Complete Table Support Test - SimpleChat</h1>
        <p class="lead">Testing all table formats: Standard Markdown, Unicode Box Tables, PSV Code Blocks, and ASCII Dash Tables</p>
        
        <div class="stats">
            <h4>Test Summary</h4>
            <div id="test-summary">Running tests...</div>
        </div>

        <!-- Test 1: Standard Markdown Table -->
        <div class="test-section">
            <h3>âœ… Test 1: Standard Markdown Table</h3>
            <p>Testing regular markdown table syntax (should work natively)</p>
            <div class="message-text" id="test1-result"></div>
        </div>

        <!-- Test 2: Unicode Box Table -->
        <div class="test-section">
            <h3>ğŸ”„ Test 2: Unicode Box Table</h3>
            <p>Testing conversion of Unicode box-drawing characters</p>
            <pre id="test2-original"></pre>
            <div class="message-text" id="test2-result"></div>
        </div>

        <!-- Test 3: PSV Code Block -->
        <div class="test-section">
            <h3>ğŸ”„ Test 3: PSV Code Block</h3>
            <p>Testing conversion of pipe-separated values in code blocks</p>
            <pre id="test3-original"></pre>
            <div class="message-text" id="test3-result"></div>
        </div>

        <!-- Test 4: ASCII Dash Table -->
        <div class="test-section">
            <h3>ğŸ”„ Test 4: ASCII Dash Table</h3>
            <p>Testing conversion of ASCII tables with em-dash separators</p>
            <pre id="test4-original"></pre>
            <div class="message-text" id="test4-result"></div>
        </div>

        <!-- Test 5: Mixed Content -->
        <div class="test-section">
            <h3>ğŸ”„ Test 5: Mixed Content</h3>
            <p>Testing multiple table formats in one message</p>
            <div class="message-text" id="test5-result"></div>
        </div>

        <div id="final-results"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked@15.0.7/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
    <script>
        // Configure marked
        marked.setOptions({
            gfm: true,
            breaks: true,
            tables: true
        });

        // Table conversion functions (from chat-messages.js)
        function unwrapTablesFromCodeBlocks(content) {
            const codeBlockPattern = /```[\\s\\S]*?```/g;
            return content.replace(codeBlockPattern, (match) => {
                const lines = match.split('\\n');
                const potentialTableLines = lines.slice(1, -1);
                
                if (potentialTableLines.length >= 2) {
                    const hasTableStructure = potentialTableLines.some(line => 
                        line.includes('|') && line.split('|').length >= 3
                    );
                    
                    if (hasTableStructure) {
                        return '\\n' + potentialTableLines.join('\\n') + '\\n';
                    }
                }
                return match;
            });
        }

        function convertUnicodeTableToMarkdown(content) {
            const boxDrawingPattern = /[â”Œâ”¬â”â”œâ”¼â”¤â””â”´â”˜â”‚â”€]+[^\\n]*\\n[\\s\\S]*?[â”Œâ”¬â”â”œâ”¼â”¤â””â”´â”˜â”‚â”€]+/g;
            return content.replace(boxDrawingPattern, (match) => {
                try {
                    const lines = match.split('\\n');
                    const dataLines = [];
                    
                    for (const line of lines) {
                        if (line.includes('â”‚') && !line.match(/^[â”Œâ”¬â”â”œâ”¼â”¤â””â”´â”˜â”‚â”€\\s]+$/)) {
                            const cells = line.split('â”‚')
                                .map(cell => cell.trim())
                                .filter((cell, index, array) => index > 0 && index < array.length - 1);
                            if (cells.length > 0) {
                                dataLines.push(cells);
                            }
                        }
                    }
                    
                    if (dataLines.length >= 2) {
                        let markdownTable = '\\n\\n';
                        markdownTable += '| ' + dataLines[0].join(' | ') + ' |\\n';
                        markdownTable += '|' + dataLines[0].map(() => '---').join('|') + '|\\n';
                        for (let i = 1; i < dataLines.length; i++) {
                            markdownTable += '| ' + dataLines[i].join(' | ') + ' |\\n';
                        }
                        markdownTable += '\\n';
                        return markdownTable;
                    }
                } catch (error) {
                    console.error('Error converting Unicode table:', error);
                }
                return match;
            });
        }

        function convertPSVCodeBlockToMarkdown(content) {
            const psvCodeBlockPattern = /```[\\s\\S]*?\\|[\\s\\S]*?```/g;
            return content.replace(psvCodeBlockPattern, (match) => {
                try {
                    const lines = match.split('\\n');
                    const psvLines = lines.slice(1, -1).filter(line => line.includes('|'));
                    
                    if (psvLines.length >= 2) {
                        const dataLines = psvLines.map(line => 
                            line.split('|').map(cell => cell.trim())
                        );
                        
                        let markdownTable = '\\n\\n';
                        markdownTable += '| ' + dataLines[0].join(' | ') + ' |\\n';
                        markdownTable += '|' + dataLines[0].map(() => '---').join('|') + '|\\n';
                        for (let i = 1; i < dataLines.length; i++) {
                            markdownTable += '| ' + dataLines[i].join(' | ') + ' |\\n';
                        }
                        markdownTable += '\\n';
                        return markdownTable;
                    }
                } catch (error) {
                    console.error('Error converting PSV table:', error);
                }
                return match;
            });
        }

        function convertASCIIDashTableToMarkdown(content) {
            const asciiTablePattern = /â”€{10,}[^\\n]*\\n[\\s\\S]*?â”€{10,}/g;
            return content.replace(asciiTablePattern, (match) => {
                try {
                    const lines = match.split('\\n');
                    const dataLines = [];
                    let headerLine = null;
                    
                    for (const line of lines) {
                        if (line.includes('â”€') && line.replace(/[â”€\\s]/g, '').length === 0) {
                            continue;
                        }
                        
                        if (line.trim() && !line.match(/^â”€+$/)) {
                            const cells = line.split(/\\s{2,}/)
                                .map(cell => cell.trim())
                                .filter(cell => cell !== '');
                            
                            if (cells.length > 1) {
                                if (!headerLine) {
                                    headerLine = cells;
                                } else {
                                    dataLines.push(cells);
                                }
                            }
                        }
                    }
                    
                    if (headerLine && dataLines.length > 0) {
                        let markdownTable = '\\n\\n';
                        markdownTable += '| ' + headerLine.join(' | ') + ' |\\n';
                        markdownTable += '|' + headerLine.map(() => '---').join('|') + '|\\n';
                        
                        for (const row of dataLines) {
                            while (row.length < headerLine.length) {
                                row.push('â€”');
                            }
                            markdownTable += '| ' + row.join(' | ') + ' |\\n';
                        }
                        markdownTable += '\\n';
                        return markdownTable;
                    }
                } catch (error) {
                    console.error('Error converting ASCII dash table:', error);
                }
                return match;
            });
        }

        // Test data
        const tests = {
            markdown: `| Name | Age | City |
|------|-----|------|
| John | 30 | NYC |
| Jane | 25 | LA |`,

            unicode: `â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Productâ”‚ Price   â”‚ Stock    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Laptop â”‚ $999.99 â”‚ 15       â”‚
â”‚ Mouse  â”‚ $29.99  â”‚ 50       â”‚
â”‚ Monitorâ”‚ $299.99 â”‚ 8        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜`,

            psv: \`\`\`
Department|Budget|Actual|Variance
Sales|100000|95000|-5000
Marketing|75000|82000|7000
IT|120000|118000|-2000
\`\`\`,

            ascii: \`â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 AGENCY          MONTH/YEAR   FORECAST        ACTUAL         VARIANCE  
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 IRS             Apr 2025     $4.02B          $3.86B         -$0.16B   
 IRS             May 2025     $4.13B          $4.23B         +$0.11B   
 IRS             Jun 2025     $4.14B          $3.99B         -$0.14B   
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\`,

            mixed: \`Here are multiple tables:

First, a markdown table:
| Item | Quantity |
|------|----------|
| Apples | 10 |

Then a Unicode table:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Country â”‚ Capital â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ USA     â”‚ DC      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

And a PSV code block:
\`\`\`
Name|Score
Alice|95
Bob|87
\`\`\`

Finally an ASCII table:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 Item    Price    
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 Coffee  $4.50    
 Tea     $3.00    
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\`
        };

        // Run tests
        function runTests() {
            const results = [];
            let tablesFound = 0;

            // Test 1: Standard Markdown
            const test1Html = DOMPurify.sanitize(marked.parse(tests.markdown));
            document.getElementById('test1-result').innerHTML = test1Html;
            const test1Success = document.getElementById('test1-result').querySelector('table') !== null;
            results.push({ name: 'Standard Markdown', success: test1Success });
            if (test1Success) tablesFound++;

            // Test 2: Unicode Box Table
            document.getElementById('test2-original').textContent = tests.unicode;
            const test2Converted = convertUnicodeTableToMarkdown(tests.unicode);
            const test2Html = DOMPurify.sanitize(marked.parse(test2Converted));
            document.getElementById('test2-result').innerHTML = test2Html;
            const test2Success = document.getElementById('test2-result').querySelector('table') !== null;
            results.push({ name: 'Unicode Box Table', success: test2Success });
            if (test2Success) tablesFound++;

            // Test 3: PSV Code Block
            document.getElementById('test3-original').textContent = tests.psv;
            const test3Converted = convertPSVCodeBlockToMarkdown(tests.psv);
            const test3Html = DOMPurify.sanitize(marked.parse(test3Converted));
            document.getElementById('test3-result').innerHTML = test3Html;
            const test3Success = document.getElementById('test3-result').querySelector('table') !== null;
            results.push({ name: 'PSV Code Block', success: test3Success });
            if (test3Success) tablesFound++;

            // Test 4: ASCII Dash Table
            document.getElementById('test4-original').textContent = tests.ascii;
            const test4Converted = convertASCIIDashTableToMarkdown(tests.ascii);
            const test4Html = DOMPurify.sanitize(marked.parse(test4Converted));
            document.getElementById('test4-result').innerHTML = test4Html;
            const test4Success = document.getElementById('test4-result').querySelector('table') !== null;
            results.push({ name: 'ASCII Dash Table', success: test4Success });
            if (test4Success) tablesFound++;

            // Test 5: Mixed Content
            let mixedProcessed = tests.mixed;
            mixedProcessed = unwrapTablesFromCodeBlocks(mixedProcessed);
            mixedProcessed = convertUnicodeTableToMarkdown(mixedProcessed);
            mixedProcessed = convertPSVCodeBlockToMarkdown(mixedProcessed);
            mixedProcessed = convertASCIIDashTableToMarkdown(mixedProcessed);
            const test5Html = DOMPurify.sanitize(marked.parse(mixedProcessed));
            document.getElementById('test5-result').innerHTML = test5Html;
            const test5Tables = document.getElementById('test5-result').querySelectorAll('table').length;
            const test5Success = test5Tables >= 4; // Should have 4 tables
            results.push({ name: \`Mixed Content (\${test5Tables}/4 tables)\`, success: test5Success });
            tablesFound += test5Tables;

            // Update summary
            const passed = results.filter(r => r.success).length;
            const total = results.length;
            document.getElementById('test-summary').innerHTML = \`
                <strong>Tests Passed: \${passed}/\${total}</strong><br>
                <strong>Total Tables Rendered: \${tablesFound}</strong><br>
                <strong>Status: \${passed === total ? 'âœ… ALL TESTS PASSED' : 'âŒ SOME TESTS FAILED'}</strong>
            \`;

            // Show detailed results
            let detailsHtml = '<h3>ğŸ“Š Detailed Test Results</h3>';
            results.forEach(result => {
                const statusClass = result.success ? 'success' : 'failure';
                const statusIcon = result.success ? 'âœ…' : 'âŒ';
                detailsHtml += \`<div class="test-result \${statusClass}">\${statusIcon} \${result.name}</div>\`;
            });

            if (passed === total) {
                detailsHtml += '<div class="test-result success">ğŸ‰ All table formats are now supported in SimpleChat!</div>';
            }

            document.getElementById('final-results').innerHTML = detailsHtml;

            console.log('ğŸ§ª Test Results:', results);
            console.log(\`ğŸ“Š Summary: \${passed}/\${total} tests passed, \${tablesFound} total tables rendered\`);
        }

        // Run tests when page loads
        window.addEventListener('load', runTests);
    </script>
</body>
</html>