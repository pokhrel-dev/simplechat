{% extends "base.html" %}
{% block title %} Public Workspaces - {{ app_settings.app_title }} {% endblock %}
{% block head %}
<link rel="stylesheet" href="/static/css/simplemde.min.css" />
<style>
  /* Adapted styles for Public Workspace */
  #public-documents-table { table-layout: fixed; width: 100%; }
  #public-documents-table th:nth-child(1), #public-documents-table td:nth-child(1) { width: 50px; text-align: left; }
  #public-documents-table th:nth-child(2), #public-documents-table td:nth-child(2) { min-width:50px; max-width:150px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
  #public-documents-table th:nth-child(3), #public-documents-table td:nth-child(3) { min-width:50px; max-width:200px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
  #public-documents-table th:nth-child(4), #public-documents-table td:nth-child(4) { width:200px; }
  .classification-badge { display:inline-block; padding:0.3em 0.6em; font-size:0.85em; font-weight:600; line-height:1; color:#fff; text-align:center; white-space:nowrap; vertical-align:baseline; border-radius:0.375rem; }
  .classification-badge.text-dark { color:#212529!important; }
  #public-documents-table td { vertical-align: middle; }
  .table-loading-row td { text-align:center; padding:1.5rem; color:#6c757d; }
  /* Filter controls styles */
  .filter-controls-row > div {
    margin-bottom: 0.5rem;
  }
  @media (min-width: 768px) {
    .filter-controls-row > div {
      margin-bottom: 0;
    }
    .filter-buttons-col {
      text-align: end;
    }
  }
  .filter-controls-row + .filter-controls-row {
    margin-top: 0.75rem;
  }
  /* Dropdown styles */
  #public-dropdown .dropdown-item { padding:0.5rem 1rem; cursor:pointer; }
  #public-dropdown .dropdown-item:hover { background-color:#f8f9fa; }
  #public-dropdown .dropdown-item.active { background-color:#0d6efd; color:#fff; }
  #public-dropdown .dropdown-menu { padding:0.5rem 0; }
  #public-dropdown .public-search-container { position:sticky; top:0; z-index:1; background:#fff; border-bottom:1px solid #dee2e6; padding-bottom:0.5rem; }
  #public-dropdown .dropdown-items-container { max-height:300px; overflow-y:auto; }
  #public-dropdown-button { text-align:left; }
</style>
{% endblock %}
{% block content %}
<div class="container">
  <h2>Public Workspace</h2>
  <h3 id="active-public-name" style="display:none"></h3>

  <div class="row mb-3">
    <div class="col-sm-6">
      <div class="dropdown" id="public-dropdown">
        <button class="form-select d-flex justify-content-between align-items-center" id="public-dropdown-button" data-bs-toggle="dropdown">
          <span class="selected-public-text">Select a workspace...</span>
        </button>
        <div class="dropdown-menu w-100" id="public-dropdown-menu">
          <div class="px-2 public-search-container d-none">
            <input type="text" class="form-control form-control-sm mb-2" placeholder="Search workspaces..." id="public-search-input" />
          </div>
          <div class="dropdown-items-container" id="public-dropdown-items"></div>
        </div>
        <select class="d-none" id="public-select"></select>
      </div>
    </div>
    <div class="col-sm-6">
      <button class="btn btn-primary" id="btn-change-public">Change Active Workspace</button>
      <button class="btn btn-secondary" id="btn-my-publics">My Public Workspaces</button>
    </div>
  </div>

  <div class="alert alert-info" id="user-public-role-display" style="display:none">
    Your role in <strong id="active-public-name-role"></strong>: <span id="user-public-role" class="fw-bold"></span>
  </div>

  <ul class="nav nav-tabs" id="publicWorkspaceTab" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="public-docs-tab-btn" data-bs-toggle="tab" data-bs-target="#public-docs-tab" type="button" role="tab">Public Documents</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="public-prompts-tab-btn" data-bs-toggle="tab" data-bs-target="#public-prompts-tab" type="button" role="tab">Public Prompts</button>
    </li>
  </ul>

  <div class="tab-content" id="publicWorkspaceTabContent">
    <!-- Documents Tab -->
    <div class="tab-pane fade show active" id="public-docs-tab" role="tabpanel">
      <div class="card p-3 my-3">
        <h5>Public Documents</h5>
        <p class="text-muted small">Documents uploaded here are visible to all authenticated users of this service.</p>
        <div class="mb-3" id="upload-public-section" style="display:none">
          <div id="upload-area" class="upload-area text-center p-4 border border-2 border-dashed rounded bg-light" style="cursor:pointer; transition: border-color 0.2s;">
            <input type="file" id="file-input" multiple style="display:none;" />
            <div class="upload-area-content">
              <i class="bi bi-cloud-arrow-up display-4 text-primary mb-2"></i>
              <div class="fw-bold">Drag & drop files here or <span class="text-primary text-decoration-underline">click to browse</span></div>
              <div class="small text-muted mt-1">
                {{ allowed_extensions }}
              </div>
            </div>
          </div>
          <span id="upload-status" class="ms-2 text-muted small" style="display:none;"></span>
          <div id="workspace-upload-progress-container" class="mt-2" style="display:none;"></div>
        </div>
        <!-- Removed <hr id="public-upload-hr"> to reduce whitespace -->

        <!-- Search/Filter Controls (collapsible) -->
        <button class="btn btn-outline-secondary btn-sm mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#public-docs-filters-collapse" aria-expanded="false" aria-controls="public-docs-filters-collapse" id="public-docs-filters-toggle-btn">
          Show Search/Filters
        </button>
        <div class="collapse" id="public-docs-filters-collapse">
          <div class="row mb-3 align-items-end filter-controls-row">
            <div class="col-md-4">
              <label for="public-docs-search-input" class="form-label mb-1 small">Search File Name/Title:</label>
              <input type="search" id="public-docs-search-input" class="form-control form-control-sm" placeholder="Enter search term..." spellcheck="false" data-ms-editor="true">
            </div>
            <div class="col-md-3">
              <label for="public-docs-classification-filter" class="form-label mb-1 small">Filter by Classification:</label>
              <select id="public-docs-classification-filter" class="form-select form-select-sm">
                <option value="">(All Classifications)</option>
                <option value="none">(No Classification)</option>
                <option value="None">None</option>
                <option value="N/A">N/A</option>
                <option value="Pending">Pending</option>
                <option value="Public">Public</option>
                <option value="CUI">CUI</option>
                <option value="ITAR">ITAR</option>
              </select>
            </div>
            <div class="col-md-5 filter-buttons-col mt-2 mt-md-0">
              <button id="public-docs-apply-filters-btn" class="btn btn-primary btn-sm">
                Apply Filters
              </button>
              <button id="public-docs-clear-filters-btn" class="btn btn-secondary btn-sm ms-1">
                Clear Filters
              </button>
            </div>
          </div>
          <div class="row mb-3 align-items-end filter-controls-row">
            <div class="col-md-3">
              <label for="public-docs-author-filter" class="form-label mb-1 small">Search Authors:</label>
              <input type="search" id="public-docs-author-filter" class="form-control form-control-sm" placeholder="Author name..." spellcheck="false" data-ms-editor="true">
            </div>
            <div class="col-md-3">
              <label for="public-docs-keywords-filter" class="form-label mb-1 small">Search Keywords:</label>
              <input type="search" id="public-docs-keywords-filter" class="form-control form-control-sm" placeholder="Keyword..." spellcheck="false" data-ms-editor="true">
            </div>
            <div class="col-md-3">
              <label for="public-docs-abstract-filter" class="form-label mb-1 small">Search Abstract:</label>
              <input type="search" id="public-docs-abstract-filter" class="form-control form-control-sm" placeholder="Abstract content..." spellcheck="false" data-ms-editor="true">
            </div>
            <div class="col-md-3 filter-buttons-col mt-2 mt-md-0">
              <!-- Buttons removed from metadata row -->
            </div>
          </div>
        </div>

        <!-- Removed duplicate filter row outside the collapsible area -->

        <table class="table table-striped" id="public-documents-table">
          <thead>
            <tr>
              <th></th>
              <!-- Expand -->
              <th>File Name</th>
              <th>Title</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Populated by JavaScript -->
            <tr class="table-loading-row">
              <td colspan="4">
                <div class="spinner-border spinner-border-sm me-2" role="status"><span class="visually-hidden">Loading...</span></div>
                Loading public documents...
              </td>
            </tr>
          </tbody>
        </table>

        <div class="d-flex align-items-center gap-3 mb-3 mt-3">
          <div>
            <label class="visually-hidden">Items per page:</label>
            <select id="public-docs-page-size-select" class="form-select form-select-sm d-inline-block" style="width:auto;"><option value="10" selected>10</option><option value="20">20</option><option value="50">50</option></select>
            <span class="ms-1 small text-muted">items per page</span>
          </div>
          <div id="public-docs-pagination-container" class="d-flex gap-1 ms-auto"></div>
        </div>
      </div>
    </div>

    <!-- Prompts Tab -->
    <div class="tab-pane fade" id="public-prompts-tab" role="tabpanel">
      <div class="card p-3 my-3">
        <h5>Public Prompts</h5>
        <div id="public-prompts-role-warning" class="alert alert-warning" style="display:none">You do not have permission to manage public prompts.</div>
        <div class="mb-3" id="create-public-prompt-section" style="display:none"><button id="create-public-prompt-btn" class="btn btn-success">New Prompt</button></div>
        
        <!-- Prompts Filters -->
        <button class="btn btn-outline-secondary btn-sm mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#public-prompts-filters-collapse" aria-expanded="false" aria-controls="public-prompts-filters-collapse" id="public-prompts-filters-toggle-btn">
          Show Search/Filters
        </button>
        <div class="collapse" id="public-prompts-filters-collapse">
          <div class="row mb-3 filter-controls-row">
            <div class="col-md-6">
              <label for="public-prompts-search-input" class="form-label mb-1 small">Search Prompt Name:</label>
              <input type="search" id="public-prompts-search-input" class="form-control form-control-sm" placeholder="Search prompt name..." />
            </div>
            <div class="col-md-6 filter-buttons-col mt-2 mt-md-0">
              <button id="public-prompts-apply-filters-btn" class="btn btn-primary btn-sm">Apply Filters</button>
              <button id="public-prompts-clear-filters-btn" class="btn btn-secondary btn-sm ms-1">Clear Filters</button>
            </div>
          </div>
        </div>
        <table class="table table-striped" id="public-prompts-table"><thead><tr><th>Prompt Name</th><th>Actions</th></tr></thead><tbody><tr class="table-loading-row"><td colspan="2"><div class="spinner-border spinner-border-sm me-2" role="status"></div> Loading public prompts...</td></tr></tbody></table>
        <div class="d-flex align-items-center gap-3 mb-3 mt-3"><div><label class="visually-hidden">Items per page:</label><select id="public-prompts-page-size-select" class="form-select form-select-sm d-inline-block" style="width:auto;"><option value="10" selected>10</option><option value="20">20</option><option value="50">50</option></select><span class="ms-1 small text-muted">items per page</span></div><div id="public-prompts-pagination-container" class="d-flex gap-1 ms-auto"></div></div>
      </div>
    </div>
  </div>
</div>

<!-- Document Metadata Modal -->
<div class="modal fade" id="publicDocMetadataModal" tabindex="-1" aria-labelledby="publicDocMetadataModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="public-doc-metadata-form">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="publicDocMetadataModalLabel">Edit Document Metadata</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Hidden doc-id field -->
          <input type="hidden" id="public-doc-id" name="doc_id" value="" />

          <!-- Document Classification -->
          <div class="mb-3" id="public-doc-classification-container">
            <label for="public-doc-classification" class="form-label">Classification</label>
            <select class="form-select" id="public-doc-classification">
              <option value="">-- Select Classification --</option>
              <option value="none">(No Classification)</option>
              <option value="None">None</option>
              <option value="N/A">N/A</option>
              <option value="Pending">Pending</option>
              <option value="Public">Public</option>
              <option value="CUI">CUI</option>
              <option value="ITAR">ITAR</option>
            </select>
          </div>

          <!-- Title -->
          <div class="mb-3">
            <label for="public-doc-title" class="form-label">Title</label>
            <input type="text" class="form-control" id="public-doc-title" />
          </div>

          <!-- Abstract -->
          <div class="mb-3">
            <label for="public-doc-abstract" class="form-label">Abstract</label>
            <textarea class="form-control" id="public-doc-abstract" rows="3"></textarea>
          </div>

          <!-- Keywords -->
          <div class="mb-3">
            <label for="public-doc-keywords" class="form-label">Keywords (comma separated)</label>
            <input type="text" class="form-control" id="public-doc-keywords" />
          </div>

          <!-- Publication Date -->
          <div class="mb-3">
            <label for="public-doc-publication-date" class="form-label">Publication Date</label>
            <input type="text" class="form-control" id="public-doc-publication-date" placeholder="e.g. 08/2005 or YYYY-MM-DD" />
          </div>

          <!-- Authors -->
          <div class="mb-3">
            <label for="public-doc-authors" class="form-label">Authors (comma separated)</label>
            <input type="text" class="form-control" id="public-doc-authors" />
          </div>
        </div>
        <!-- end modal-body -->

        <div class="modal-footer">
          <button id="public-doc-save-btn" type="submit" class="btn btn-primary">Save Metadata</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Prompt Modal -->
<div class="modal fade" id="publicPromptModal" tabindex="-1"><div class="modal-dialog modal-xl"><form id="public-prompt-form"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="publicPromptModalLabel">Create Public Prompt</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="public-prompt-id" /><div class="mb-3"><label for="public-prompt-name" class="form-label">Prompt Name</label><input type="text" class="form-control" id="public-prompt-name" required /></div><div class="mb-3"><label for="public-prompt-content" class="form-label">Prompt Content</label><textarea class="form-control" id="public-prompt-content" rows="10"></textarea></div></div><div class="modal-footer"><button id="public-prompt-save-btn" type="submit" class="btn btn-primary">Save Prompt</button></div></div></form></div></div>
{% endblock %}
{% block scripts %}
<script>
  // Pass settings to JavaScript
  window.max_file_size_mb = {{ settings.max_file_size_mb | default(16) }};
</script>
<script src="/static/js/public/public_workspace.js"></script>
<script>
  // --- Filter toggle button logic and upload status/progress visibility ---
  document.addEventListener("DOMContentLoaded", function() {
    // Search/Filter toggle
    var docsToggleBtn = document.getElementById("public-docs-filters-toggle-btn");
    var docsCollapse = document.getElementById("public-docs-filters-collapse");
    if (docsToggleBtn && docsCollapse) {
      docsCollapse.addEventListener("show.bs.collapse", function() {
        docsToggleBtn.textContent = "Hide Search/Filters";
      });
      docsCollapse.addEventListener("hide.bs.collapse", function() {
        docsToggleBtn.textContent = "Show Search/Filters";
      });
    }
    
    // Prompts tab
    var promptsToggleBtn = document.getElementById("public-prompts-filters-toggle-btn");
    var promptsCollapse = document.getElementById("public-prompts-filters-collapse");
    if (promptsToggleBtn && promptsCollapse) {
      promptsCollapse.addEventListener("show.bs.collapse", function() {
        promptsToggleBtn.textContent = "Hide Search/Filters";
      });
      promptsCollapse.addEventListener("hide.bs.collapse", function() {
        promptsToggleBtn.textContent = "Show Search/Filters";
      });
    }

    // Hide upload status and progress container unless needed
    var uploadStatus = document.getElementById("upload-status");
    var uploadProgress = document.getElementById("workspace-upload-progress-container");
    if (uploadStatus) uploadStatus.style.display = "none";
    if (uploadProgress) uploadProgress.style.display = "none";

    function showUploadStatusIfNeeded() {
      if (uploadStatus && uploadStatus.textContent.trim() !== "") {
        uploadStatus.style.display = "";
      } else if (uploadStatus) {
        uploadStatus.style.display = "none";
      }
      if (uploadProgress && uploadProgress.children.length > 0) {
        uploadProgress.style.display = "";
      } else if (uploadProgress) {
        uploadProgress.style.display = "none";
      }
    }

    // Patch the upload logic to call showUploadStatusIfNeeded after updates
    var origSetStatus = uploadStatus && Object.getOwnPropertyDescriptor(Object.getPrototypeOf(uploadStatus), 'textContent')?.set;
    if (uploadStatus && origSetStatus) {
      Object.defineProperty(uploadStatus, 'textContent', {
        set: function(value) {
          origSetStatus.call(this, value);
          showUploadStatusIfNeeded();
        },
        get: function() {
          return origSetStatus.get ? origSetStatus.get.call(this) : this.innerText;
        }
      });
    }
    if (uploadProgress) {
      var observer = new MutationObserver(showUploadStatusIfNeeded);
      observer.observe(uploadProgress, { childList: true, subtree: false });
    }
    showUploadStatusIfNeeded();
  });
</script>

<script>
  // Function to toggle document details
  function togglePublicDetails(docId) {
    const detailsRow = document.getElementById(`public-details-row-${docId}`);
    const arrowIcon = document.getElementById(`public-arrow-icon-${docId}`);
    
    if (!detailsRow || !arrowIcon) return;
    
    if (detailsRow.style.display === "none") {
      detailsRow.style.display = "";
      arrowIcon.className = "bi bi-chevron-down";
    } else {
      detailsRow.style.display = "none";
      arrowIcon.className = "bi bi-chevron-right";
    }
  }
  
  // Make the function globally available
  window.togglePublicDetails = togglePublicDetails;
  
  // Note: Document action functions are implemented in public_workspace.js
</script>
{% endblock %}
